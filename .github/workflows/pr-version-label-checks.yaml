name: "Check version labels on PR"
on:
  workflow_call:

permissions:
  pull-requests: write
  contents: read

jobs:
  labels:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check labels
        id: check-labels
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          MAJOR=0
          MINOR=0
          PATCH=0
          BUMP_TYPE=""
          
          for LABEL in $(gh pr view ${{ github.event.pull_request.number }} --json labels | jq -r '.labels[].name'); do
            if [ "$LABEL" = "major" ]; then
              MAJOR=1
            elif [ "$LABEL" = "minor" ]; then
              MINOR=1
            elif [ "$LABEL" = "patch" ]; then
              PATCH=1
            fi
          done
          
          if [ $MAJOR -eq 1 ]; then
            BUMP_TYPE='major'
          elif [ $MINOR -eq 1 ]; then
            BUMP_TYPE='minor'
          elif [ $PATCH -eq 1 ]; then
            BUMP_TYPE='patch'
          else
            echo "error=error" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          gh pr edit ${{ github.event.pull_request.number }} --add-label "${BUMP_TYPE}-bump"
          
          # Now we know the bump type, we need to check that the PR doesn't have a conflicting label
          gh pr view ${{ github.event.pull_request.number }} --json labels | jq -r '.labels[].name'
          for CONFLICTING_LABEL in $(gh pr view ${{ github.event.pull_request.number }} --json labels | jq -r '.labels[].name'); do
            gh pr edit ${{ github.event.pull_request.number }} --remove-label "$CONFLICTING_LABEL"
          done

      - uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405  # v2.9.4
        if: always() && (steps.check-labels.outputs.error != null)
        with:
          header: pr-labels-error
          message: |
            The PR must have one of the following labels: `major`, `minor`, or `patch`.
            Please add one of these labels to the PR.

      # Delete a previous comment when the issue has been resolved
      - if: ${{ steps.check-labels.outputs.error == null }}
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405  # v2.9.4
        with:
          header: pr-labels-error
          delete: true
