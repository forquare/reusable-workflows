name: "Check version labels on PR"
on:
  workflow_call:

jobs:
  labels:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Get PR Labels
        id: pr-labels
        uses: joerick/pr-labels-action@0543b277721e852d821c6738d449f2f4dea03d5f  # v1.0.9

      - name: Check labels
        id: check-labels
        run: |
          MAJOR=0
          MINOR=0
          PATCH=0
          
          for LABEL in ${{ steps.pr-labels.outputs.labels }}; do
            if [[ "$LABEL" == "major" ]]; then
              MAJOR=1
            elif [[ "$LABEL" == "minor" ]]; then
              MINOR=1
            elif [[ "$LABEL" == "patch" ]]; then
              PATCH=1
            fi
          done
          
          if [[ $MAJOR -eq 1 ]]; then
            echo "bump=major" >> $GITHUB_OUTPUT
          elif [[ $MINOR -eq 1 ]]; then
            echo "bump=minor" >> $GITHUB_OUTPUT
          elif [[ $PATCH -eq 1 ]]; then
            echo "bump=patch" >> $GITHUB_OUTPUT
          else
            echo "error=error" >> $GITHUB_OUTPUT
            exit 1
          fi

      - uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405  # v2.9.4
        if: always() && (steps.check-labels.outputs.error != null)
        with:
          header: pr-labels-error
          message: |
            The PR must have one of the following labels: `major`, `minor`, or `patch`.
            Please add one of these labels to the PR.

      # Delete a previous comment when the issue has been resolved
      - if: ${{ steps.check-labels.outputs.error == null }}
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405  # v2.9.4
        with:
          header: pr-labels-error
          delete: true

      - name: Set version bump type
        run: gh pr edit ${{ github.event.pull_request.number }} --add-label "${{ steps.check-labels.outputs.bump }}-bump"
